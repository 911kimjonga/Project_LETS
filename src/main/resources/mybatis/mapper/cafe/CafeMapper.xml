<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.vj.lets.domain.cafe.mapper.CafeMapper">

    <insert id="create" parameterType="Cafe">
        INSERT INTO CAFE (ID, EMAIL, NAME, PHONE_NUMBER, DETAIL_ADDRESS, LATITUDE, LONGITUDE, ROOM_COUNT,
                          START_TIME, END_TIME, DESCRIPTION, IMAGE_PATH, BUSINESS_NUMBER,
                          SI_GUN_GU_ID, MEMBER_ID, ROAD_ADDRESS)
        VALUES (CAFE_ID_SEQ.NEXTVAL, #{email}, #{name}, #{phoneNumber}, #{detailAddress}, #{latitude}, #{longitude},
                #{roomCount}, #{startTime}, #{endTime}, #{description}, #{imagePath}, #{businessNumber},
                #{siGunGuId}, #{memberId}, #{roadAddress})
    </insert>

    <update id="update" parameterType="Cafe">
    UPDATE CAFE
    <set>
        <if test="name != null and name != ''">NAME = #{name},</if>
        <if test="phoneNumber != null and phoneNumber != ''">PHONE_NUMBER= #{phoneNumber},</if>
        <if test="detailAddress != null and detailAddress != ''">DETAIL_ADDRESS = #{detailAddress},</if>
        <if test="roadAddress != null and roadAddress != ''">LATITUDE = #{latitude},</if>
        <if test="roadAddress != null and roadAddress != ''">LONGITUDE = #{longitude},</if>
        <if test="roomCount != null and roomCount != ''">ROOM_COUNT = #{roomCount},</if>
        <if test="startTime != null and startTime != ''">START_TIME = #{startTime},</if>
        <if test="endTime != null and endTime != ''">END_TIME = #{endTime},</if>
        <if test="description != null and description != ''">DESCRIPTION = #{description},</if>
        <if test="imagePath != null and imagePath != ''">IMAGE_PATH = #{imagePath},</if>
        <if test="businessNumber != null and businessNumber != ''">BUSINESS_NUMBER = #{businessNumber},</if>
        <if test="roadAddress != null and roadAddress != ''">SI_GUN_GU_ID = #{siGunGuId},</if>
        <if test="roadAddress != null and roadAddress != ''">ROAD_ADDRESS = #{roadAddress},</if>
    </set>
    </update>

    <select id="findById" parameterType="int" resultType="Cafe">
        SELECT ID, EMAIL, NAME, PHONE_NUMBER, DETAIL_ADDRESS, LATITUDE, LONGITUDE, ROOM_COUNT,
               START_TIME, END_TIME, DESCRIPTION, IMAGE_PATH, TO_CHAR(regdate, 'yyyy-MM-DD') regdate, BUSINESS_NUMBER,
               STATUS, SI_GUN_GU_ID, MEMBER_ID, ROAD_ADDRESS
        FROM CAFE
        Where ID = #{id}
          AND STATUS = 'enabled'
    </select>

    <select id="findByAll" resultType="Cafe">
        SELECT ID, EMAIL, NAME, PHONE_NUMBER, DETAIL_ADDRESS, LATITUDE, LONGITUDE, ROOM_COUNT,
               START_TIME, END_TIME, DESCRIPTION, IMAGE_PATH, TO_CHAR(regdate, 'yyyy-MM-DD') regdate, BUSINESS_NUMBER,
               STATUS, SI_GUN_GU_ID, MEMBER_ID, ROAD_ADDRESS
        FROM CAFE
        WHERE STATUS = 'enabled'
        ORDER BY regdate DESC
    </select>

    <select id="findByBest" resultType="int">
        SELECT C.ID
        FROM CAFE C
                 LEFT JOIN RESERVATION RV ON C.ID = RV.CAFE_ID
        WHERE ROWNUM &lt;= 6 AND STATUS = 'enabled'
        GROUP BY C.ID
        ORDER BY COUNT(RV.ID) DESC
    </select>

    <select id="findBySearch" parameterType="CafeSearch" resultType="Cafe">
        SELECT ID, NAME, DETAIL_ADDRESS, LATITUDE, LONGITUDE, START_TIME, END_TIME, IMAGE_PATH,
                SI_GUN_GU_ID, ROAD_ADDRESS
        FROM CAFE
        WHERE
            STATUS = 'enabled'
        <if test="name != null and name != ''">OR NAME = '%' || #{name} || '%'</if>
        <if test="minDuration != null and minDuration != '' and maxDuration != null and maxDuration != ''">OR
            WHERE  DISTNACE_WGS84(LATITUDE, LONGITUDE, #{currentY}, #{currentX}) BETWEEN #{minDuration} AND #{maxDuration}</if>
        <if test="minDuration != null and minDuration != '' and maxDuration != null and maxDuration != ''">ORDER BY  DISTNACE_WGS84(LATITUDE, LONGITUDE, #{currentY}, #{currentX}) ASC</if>
    </select>

    <update id="delete" parameterType="int">
        UPDATE CAFE
        SET STATUS = 'disabled'
        WHERE ID = #{id}
    </update>

</mapper>